{% extends 'base.html' %} 
{% block content %}
{% load static %}

<head>
    <script src="{% static '/js/bootstrap.min.js' %}"></script>
    <script src="{% static '/js/jquery.min.js' %}"></script>
    <script src="{% static '/js/popper.min.js' %}"></script>
    <script type="text/javascript" src="{% static '/bootstrap-4.0.0/dist/js/bootstrap.min.js'%}"></script>
    <script type="text/javascript" src="{% static '/bootstrap-4.0.0/dist/js/bootstrap.bundle.min.js'%}"></script>
    <link rel="stylesheet" type="text/css" media="screen" href="{% static '/css/bootstrap.min.css' %}">
    <script src="{% static '/js/jquery-3.3.1.js' %}"></script>
    <script src="{% static '/DataTables/datatables.min.js' %}"></script>
    <script src="{% static '/js/dataTables.bootstrap4.min.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static '/DataTables/datatables.min.css' %}" />
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
    <script src="{% static '/js/select2.min.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static '/css/select2.min.css' %}" />
    <link rel="stylesheet" type="text/css" media="screen" href="{% static '/css/select2.min.css' %}">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="{% static '/js/select2.min.js' %}"></script>
    <script src="{% static 'js/timepicker.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static '/css/select2.min.css' %}" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.2/css/jquery.dataTables.min.css">
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="{% static '/js/select2.min.js' %}"></script>
</head>    

<style>
    * {
        box-sizing: border-box;
    }
    .input,
    .container
    {
        max-width: 1500px
    }
    input[type=text]
    {
        width: 100%;
        padding: 12px 20px;
        margin: 2px 0;
        display: block;
        /* border: 1.5px solid rgb(14, 12, 12); */
        border-radius: 4px;
        box-sizing: border-box;
    }
    input[type=submit] 
    {
        width: 40%;
        text-align: center;
        background-color: #4CAF50;
        color: rgb(15, 12, 12);
        padding: 14px 20px;
        margin: 2px 0;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    input[type=submit]:hover 
    {
        background-color: #45a049;
        text-align: center;
    }
    input[type=button] 
    {
        width: 30%;
        text-align: center;
        background-color: #4CAF50;
        color: white;
        padding: 6px 6px;
        margin: 2px 0;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
    input[type=button]:hover 
    {
        background-color: #45a049;
        text-align: center;
    }
      /* #viewbtn{
        margin-left:1050px;
      } */
    .inputtag
    {
        height:20px;
    }
    .modal-dialog-full-width 
    {
        width: 100% !important;
        height: 100% !important;
        margin: 0 !important;
        padding: 3% !important;
        max-width:none !important;
        text-align: center !important;
    }
    .modal-content-full-width  
    {
        height: auto !important;
        min-height: 100% !important;
        border-radius: 0 !important; 
        text-align: center !important;  
    }
    .modal-header-full-width  
    {
        border-bottom: 0px solid #9ea2a2 !important;
    }
    .modal-footer-full-width  
    {
        border-top: 0px solid #9ea2a2 !important;
    }
</style>

<body>
    <h3><center>Accepted Reply</center></h3> 
    <br>
    <div class="container" id="container1" style="margin-bottom:5%; text-align: center;" >
        <!-- filters in the pending view, reply and sent -->
        <div class="row" style="text-align: center; padding-left: 8em;" >
            <div class="col-md-2"  style="margin-left:2em ;">
                <label for="Zone" >Rly./Org.</label>
                <select class="form-control" name="rly_id" id="rly_id" class="custom-select" style="max-width:100%;height:2em">
                    <option value="" selected>All</option>
                    {% for z in zone %}
                    <option value="{{z}}">{{z}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="division">Div./Unit</label>
                <select class="form-control" name="div_id" id="div_id" class="custom-select" style="max-width:100%;;height:2em">
                    <option value="" selected>All</option>
                    {% for d in division %}
                    <option value="{{d}}">{{d}}</option>
                    {% endfor %}
                </select>  
            </div>
            <div class="col-md-2">
                <label for="division">Department</label>
                <select class="form-control" name="dept_id" id="dept_id" class="custom-select" style="max-width:100%;;height:2em">
                    <option value="" selected>All</option>
                    {% for d in dept %}
                    <option value="{{d}}">{{d}}</option>
                    {% endfor %}
                </select> 
            </div>
            <div class="col-md-2">
                <label style="width:10em">Date Range</label>
                <label id="reportrange" style="width:15em;background: #fff; cursor: pointer;border: 1px solid #ccc;height:2em">
                <i class="fa fa-calendar"></i>
                <span></span> 
                <i class="fa fa-caret-down"></i>
                </label>
            </div>
            <div class="col-md-3">
                <button type="button" id="submit_filter" style="margin-top:2em;width:5em;border: 1px solid #ccc;" class="btn btn-success" onclick="compliance_filterdata(this);">Search</button>
                <button type="button" style="margin-top:2em;width:5em;border: 1px solid #ccc;" class="btn btn-secondary" onclick="compliance_alterdata();">Clear</button>
            </div>
        </div>
        <br>
    <!-- table for viewing the inspection details -->
        <!-- <div class="container"> -->
            <table id="tableshow" class="table table-striped table-bordered table-sm " cellspacing="0">
            <thead style="background-color:black; color:white">
                <tr style="text-align:left">
                    <th>S.No.</th>
                    <th>Insp. Note No</th>
                    <th>Insp. Title</th>
                    <th>Insp. Officer</th>
                    <th>Insp. Date</th>
                    <!-- <th>Viewed On</th> -->
                    <th>View</th>
                    <!-- <th>Accepted Reply</th> -->
                </tr>
            </thead>
            <tbody>
                {% for i in listgrid %}
                <tr style="text-align:left">
                    <td>{{forloop.counter}}</td>
                    <td width="15%">{{i.inspection_note_no}}</td>
                    <td>{{i.inspection_title}}</td>
                    <td>{{i.inspection_officer}}</td>
                    <td>{{i.inspected_on}}</td>
                    <!-- {% if i.start_date or i.end_date %}
                        <td>{{i.start_date|date:"d-m-y" }} to {{i.end_date|date:"d-m-y" }}</td>
                    {% else %}
                        <td>NA</td>
                    {% endif %} -->
                    <!-- <td>{{i.viewed_on}}</td> -->
                    <td style="width:15.5%">
                        <button type="button" class="btn btn-primary"><a href="{% url 'inspectionReportPdf' i.inspection_no %}"  style="color: white" target="blank">Report</button></a> 
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#ReplyModal" id={{i.inspection_no}} onclick="reply(this)">Reply</button>
                    </td>
                </tr>
            {% endfor %}  
            </tbody>
        </table>
        <!-- </div>  -->
    </div> 

    <!-- Modal for reply accept-->
    <div class="modal fade right" id="ReplyModal" tabindex="-1" role="dialog" aria-labelledby="ReplyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-full-width modal-dialog-scrollable" role="document">
    <div class="modal-content modal-content-full-width">
        <div class="modal-header modal-header-full-width">
            <h3 class="modal-title w-100 text-center" id="ReplyModalLabel">List of Accepted Replies</h3><br>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body" style="text-align: left;">
            <div class="row">
                <div class="col-md-3">
                    <label >Inspection Note No</label>
                    <input type="text" value="" id="ins_note_id" readonly class="form-control" readonly/>
                </div>
                &nbsp;&nbsp;
                <div class="col-md-3">
                    <label >Officer Designation</label>
                    <input type="text" value="" id="ins_desig" readonly class="form-control" readonly/>
                </div>
                &nbsp;&nbsp;
                <div class="col-md-3">
                    <label>Inspection Officer</label>
                    <input type="text" value="" id="ins_officer" class="form-control" readonly/>
                </div>
                &nbsp;&nbsp;
                <div class="col-md-2">
                    <label>Inspection Date</label>
                    <input type="text" value="" id="ins_date" class="form-control" readonly/>
                </div>
            </div>
            <div class="row">
                <div class="col-md-11">
                    <label>Inspection Title</label>
                    <input type="text" value="" class="form-control" id="ins_title" readonly/>
                </div>
                &nbsp;&nbsp;
                <div class="col-md-2" >
                    <input type="text" value=""  id="ins_id" readonly class="form-control" hidden/>
                </div>
            </div>
            <br>
            <table id="mytable1" class="table table-striped table-bordered table-lg ">
                <thead>
                    <tr>
                        <th>Item No</th>
                        <th>Observation</th>
                        <th>Compliance Status</th>
                        <th>Compliance</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div><!--  Modal Body -->
        <div class="modal-footer modal-footer-full-width">
            <button type="button" class="btn btn-secondary" data-dismiss="modal" id="closereply">Close</button>
        </div>
    </div><!-- Modal-Content-->
    </div><!-- Modal-Dialog -->
    </div><!-- Modal -->

    <br><br>
</body>

<script>
    $( document ).ready
    (
        function() 
        {
            // gunjan
            $('#tableshow').DataTable();

            $('#container2').hide();
            compliance_form_accept();
        }
    );
    
    $('#mytable').hide();
    $("#rly_id").select2();
    $("#div_id").select2();
    $("#dept_id").select2();

    function reply(e)
    {
        var inspection_id=e.id;
        var table = $('#mytable1').DataTable();
        table.destroy();
        $('#mytable1').hide();
        data=
        {
            'inspection_id':inspection_id,
            'str':'reply',
            'status':'A',
        }
        $.ajax
        ({
            url: "{% url 'compliance_filterdata_ajax' %}",
            method: "GET",
            dataType: "JSON",
            async: false,
            data: data,
            success: function (response) 
            {
                // gunjan
                desigdetails=response.desigdetails;
                if(desigdetails.length != 0)
                {$('#ins_desig').val(desigdetails[0]['designation']);}
                else
                {$('#ins_desig').val('Null');}
                // namedetails=response.namedetails;
                // if(namedetails.length != 0)
                // {$('#ins_officer').val(namedetails[0]['empname']);}
                // else
                // {$('#ins_officer').val('Null');}
                
                idetails=response.idetails;
                $('#ins_id').val(idetails[0]['inspection_no']);
                $('#ins_note_id').val(idetails[0]['inspection_note_no']); 
                // $('#ins_officer').val(idetails[0]['empname']);
                // $('#ins_desig').val(idetails[0]['desig_longdesc']);           
                $('#ins_title').val(idetails[0]['inspection_title']);
                $('#ins_date').val(idetails[0]['inspection_date']);
                $('#ins_officer').val(idetails[0]['empname']);
                replydata=response.itemdetails;
                let row = "";
                let head = 
                    `<thead>
                    <tr align="left">
                        <th>Item No</th>
                        <th>Observations of Inspecting Officer</th>
                        <th>Accepted Compliance Remarks</th>
                        <th>Replied on</th>
                    </tr>
                    </thead>`;
                for (let i = 0; i < replydata.length; i++) 
                {
                    // alert(replydata[i]['item_no']);
                    row += "<tr>";    
                    row += `<td width=10%>${replydata[i]['item']}</td>
                    <td align="left">${replydata[i]['observation']}</td>`;
                    row += `<td align="left"><input type="text" id="${replydata[i]['item_no']}/" name="comp_remarks" style="height:7%;background-Color:lightblue;" value="${replydata[i]['compliance']}" readonly></td>`;
                    row += `<td width=10%>${replydata[i]['reply_on']}</td>`
                }
                $('#mytable1 thead').remove();
                $('#mytable1 tr').remove();
                $('#mytable1').append(head);
                $('#mytable1 tbody').append(row);
                $('#mytable1').show();
                $('#mytable1').DataTable();
            }
        })
    }
   
    function compliance_filterdata(e)
    {
        var table = $('#tableshow').DataTable();
        table.destroy();
        $('#tableshow').hide();
        var str=e.id;
        // alert(str); 
        // $('#tableshow').hide();
        // $('#tableshow').DataTable().clear().destroy();
        var data={}
        if(str=='submit_filter')
        {
            var div_id=$('#div_id').val();
            var rly_id=$('#rly_id').val();
            var dept_id=$('#dept_id').val();
            var d=$('#reportrange').data('daterangepicker').startDate;
            var startDate = new Date(d);
            startDate= startDate.getFullYear()+ '-' + (startDate.getMonth()+1) + '-' + startDate.getDate()
            d=$('#reportrange').data('daterangepicker').endDate;
            var endDate = new Date(d);
            endDate=endDate.getFullYear() + '-' +(endDate.getMonth()+1) + '-' + endDate.getDate()
            data=
            {
                'div_id':div_id,
                'rly_id':rly_id,
                'startDate':startDate,
                'endDate': endDate,
                'dept_id':dept_id,
                'str':'accept'
            }
        }
        $.ajax
        ({
            url: "{% url 'compliance_filterdata' %}",
            method: "GET",
            dataType: "JSON",
            async: false,
            data: data,
            success: function (response) 
            {
                let filterdata = response.inspect_details;
                // let desigdata = response.desig_details;
                // console.log(desigdata)
                let row = "";
                let head = 
                    `<thead style="background-color:black; color:white">
                        <tr align=left>
                            <th>S.No.</th><th style="display:none;"></th>
                            <th>Insp. Note No</th>
                            <th>Insp. Title</th>
                            <th>Insp. Officer</th>
                            <th>Insp. Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>`;
                for (let i = 0; i < filterdata.length; i++) 
                {
                    row += "<tr align=left>";
                    row += `<td>${filterdata[i]['sr_no']}</td><td style="display:none;">${filterdata[i]['inspection_no']}</td>
                    <td>${filterdata[i]['inspection_note_no']}</td>
                    <td>${filterdata[i]['inspection_title']}</td>
                    <td>${filterdata[i]['inspection_officer']}</td>
                    <td>${filterdata[i]['inspected_on']}</td>
                    <td style="width:15.5%; text-align:left">
                        <a type="button" class="btn btn-primary" href="/inspectionReportPdf/${filterdata[i]['inspection_no']}" style="color: white;" target="blank" onclick="viewdate(this)">Report</a></button>
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#ReplyModal" id="${filterdata[i]['inspection_no']}" onclick="reply(this)">Reply</button>
                    </td>`;
                    row += "</tr>";                    
                }
                $('#tableshow thead').remove();
                $('#tableshow tr').remove();
                $('#tableshow').append(head);
                $('#tableshow tbody').append(row);
                $('#tableshow').show();
                $('#tableshow').DataTable();
            }
        })
    }

    function compliance_alterdata()
    {
        $.ajax
        ({
            url:"{% url 'compliance_alterdata' %}",
            method:"GET",
            dataType:"JSON",
            async: false,
            success: function(response)
            {
                change_div=response.change_div;
                change_rly=response.change_rly;
                change_dept=response.change_dept;
                $('#div_id').empty();
                $('#div_id').append(`<option value="">All</option>`);
                $('#rly_id').empty();
                $('#rly_id').append(`<option value="">All</option>`);
                $('#dept_id').empty();
                $('#dept_id').append(`<option value="">All</option>`);
                for (let i = 0; i < change_div.length; i++) 
                {$('#div_id').append
                    (
                        `<option value="${change_div[i]}">${change_div[i]}</option>`
                    );
                }
                for (let i = 0; i < change_rly.length; i++) 
                {$('#rly_id').append
                    (
                        `<option value="${change_rly[i]}">${change_rly[i]}</option>`
                    );
                }
                for (let i = 0; i < change_dept.length; i++) 
                {$('#dept_id').append
                    (
                        `<option value="${change_dept[i]}">${change_dept[i]}</option>`
                    );
                }
            }
        })
    }
    
    $('#rly_id').change(function() 
    {
        var rly_id=$('#rly_id').val();
        data=
        {
            'rly_id':rly_id,
            'str':'filter',
        }
        $.ajax
        ({
            url: "{% url 'compliance_filterdata_ajax' %}",
            method: "GET",
            dataType: "JSON",
            async: false,
            data: data,
            success: function (response) 
            {
                div=response.div;
                $('#div_id').empty();
                $('#div_id').append(`<option value="">All</option>`);
                for (let i = 0; i < div.length; i++) 
                {
                    $('#div_id').append
                    (
                        `<option value="${div[i]}">
                        ${div[i]}
                        </option>`);
                }
            }
        })   
    });

    function compliance_form_accept()
    {
        $('#container2').show();
        $('#tableshow').show();
        var start = moment().subtract(29, 'days');
        var end = moment();
        function cb(start, end) 
        {
            // $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
            $('#reportrange span').html(start.format('D/M/YY') + ' to ' + end.format('D/M/YY'));
        }
        $('#reportrange').daterangepicker
        ({
            startDate: start,
            endDate: end,
            maxDate: new Date(),
            ranges: 
            {
                'Today': [moment(), moment()],
                'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                'This Month': [moment().startOf('month'), moment().endOf('month')],
                'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            }
        },cb);
        // cb(start, end);
    }
</script>

{% endblock %}